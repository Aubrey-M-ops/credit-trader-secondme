generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String   @id @default(cuid())
  supabaseUserId String   @unique @map("supabase_user_id")
  email          String?
  name           String?
  avatarUrl      String?  @map("avatar_url")

  // Wallet fields
  balance     Decimal @default(100.00) @db.Decimal(10, 2)
  totalEarned Decimal @default(0.00) @map("total_earned") @db.Decimal(10, 2)
  totalSpent  Decimal @default(0.00) @map("total_spent") @db.Decimal(10, 2)

  // Statistics
  completedTasks Int      @default(0) @map("completed_tasks")
  rating         Decimal? @db.Decimal(3, 2)

  // Status
  status String @default("active") // active, suspended

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  agents       Agent[]

  @@map("users")
}

model Task {
  id               String @id @default(cuid())
  title            String
  description      String @db.Text
  context          Json? // Additional context for the task
  estimatedTokens  Int    @map("estimated_tokens")
  estimatedCredits Int    @map("estimated_credits") // Credits cost
  priority         String @default("medium") // low, medium, high
  status           String @default("pending") // pending, accepted, executing, completed, cancelled, failed

  // Publisher Agent
  publisherAgentId String @map("publisher_agent_id")
  publisherAgent   Agent  @relation("publisher", fields: [publisherAgentId], references: [id], onDelete: Cascade)

  // Worker Agent
  workerAgentId String? @map("worker_agent_id")
  workerAgent   Agent?  @relation("worker", fields: [workerAgentId], references: [id], onDelete: SetNull)

  // Result
  result       String? @db.Text
  actualTokens Int?    @map("actual_tokens") // Actual tokens used
  rating       Int? // 1-5 rating

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  acceptedAt  DateTime? @map("accepted_at")
  completedAt DateTime? @map("completed_at")

  creditTransactions CreditTransaction[]
  activityFeeds      ActivityFeed[]

  @@index([status])
  @@index([publisherAgentId])
  @@index([workerAgentId])
  @@index([priority])
  @@index([createdAt])
  @@map("tasks")
}

// Credit Transaction table - tracks token->credit conversion and spending
model CreditTransaction {
  id String @id @default(cuid())

  // Task reference
  taskId String @map("task_id")
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Agent reference
  agentId String @map("agent_id")
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Transaction type: earn (completed task) or spend (published task)
  type String // earn, spend

  // Amount
  credits Int // Credits earned or spent
  tokens  Int // Tokens contributed or saved

  // Balance after transaction
  balanceAfter Int @map("balance_after")

  // Status
  status String @default("completed") // completed, pending, failed, refunded

  // Metadata
  description String? @db.Text
  metadata    Json?

  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@index([agentId])
  @@index([taskId])
  @@index([type])
  @@index([createdAt])
  @@map("credit_transactions")
}

// Activity Feed table - for homepage dynamic feed
model ActivityFeed {
  id String @id @default(cuid())

  // Event type
  eventType String @map("event_type") // task_published, task_accepted, task_completed, task_cancelled

  // Agent reference
  agentId String @map("agent_id")
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Task reference (optional)
  taskId String? @map("task_id")
  task   Task?   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Event data
  title       String
  description String? @db.Text
  metadata    Json? // Additional event data (tokens, credits, etc.)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventType])
  @@index([agentId])
  @@index([taskId])
  @@index([createdAt])
  @@map("activity_feeds")
}

// Agent table for OpenClaw agents
model Agent {
  id String @id @default(cuid())

  // Authentication
  apiKey     String @unique @map("api_key") // First 11 chars for lookup (ct_...)
  apiKeyHash String @map("api_key_hash") // bcrypt hash of full key
  name       String // OpenClaw自己命名

  // Claim information
  claimCode        String @unique @map("claim_code") // 8-char claim code for /claim/:code
  verificationCode String @map("verification_code") // 6-char verification code (XYZ-789)

  // User relationship (SecondMe OAuth)
  userId    String?   @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  claimedAt DateTime? @map("claimed_at")

  // Credits and statistics
  credits           Int @default(100) // Starting credits (integer for simplicity)
  totalEarned       Int @default(0) @map("total_earned") // Total credits earned
  totalSpent        Int @default(0) @map("total_spent") // Total credits spent
  tokensSaved       Int @default(0) @map("tokens_saved") // Tokens saved by others helping
  tokensContributed Int @default(0) @map("tokens_contributed") // Tokens contributed to help others
  tasksPublished    Int @default(0) @map("tasks_published")
  tasksCompleted    Int @default(0) @map("tasks_completed")
  reputation        Int @default(0) // Reputation score

  // Status
  status        String    @default("unclaimed") // unclaimed, claimed, active, paused, suspended
  lastActive    DateTime  @default(now()) @map("last_active")
  lastHeartbeat DateTime? @map("last_heartbeat")

  // Metadata
  capabilities Json? // Agent capabilities
  preferences  Json? // Agent preferences
  userAgent    String? @map("user_agent")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  publishedTasks     Task[]              @relation("publisher")
  workerTasks        Task[]              @relation("worker")
  creditTransactions CreditTransaction[]
  activityFeeds      ActivityFeed[]

  @@index([claimCode])
  @@index([userId])
  @@index([status])
  @@index([lastHeartbeat])
  @@map("agents")
}
